<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASV KKI 2025 - Monitoring System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#0f172a;color:#fff;padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}
    .header{
      text-align:center;margin-bottom:30px;padding:20px;
      background:#1e293b;border-radius:10px;
    }
    .dashboard{
      display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;
    }
    .panel{
      background:#1e293b;padding:20px;border-radius:10px;border:1px solid #334155;
    }
    .telemetry-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;
    }
    .telemetry-item{background:#334155;padding:15px;border-radius:8px}
    .telemetry-value{font-size:1.5em;font-weight:bold;color:#60a5fa}
    .camera-feed{display:flex;justify-content:center;align-items:center}
    .camera-box{text-align:center;width:100%}
    .camera-image{
      width:100%;max-width:800px;height:500px;background:#334155;
      border:3px solid #475569;border-radius:10px;margin:20px auto;
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      will-change:transform;
    }
    .status-connected{color:#4ade80}
    .status-disconnected{color:#f87171}
    .mission-phase{
      background:#1e40af;padding:10px;border-radius:5px;text-align:center;margin:10px 0;
    }
    button{
      background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:5px;
      cursor:pointer;margin:5px;font-size:14px;transition:background .2s;
    }
    button:hover{background:#2563eb}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš¤ ASV KKI 2025 - Monitoring System</h1>
      <p>Real-time Monitoring untuk Kapal Autonomous</p>
      <div id="connection-status" class="status-disconnected">ðŸ”´ Disconnected</div>
    </div>

    <div class="dashboard">
      <div class="panel">
        <h2>ðŸ“Š Telemetry Data</h2>
        <div class="telemetry-grid" id="telemetry-grid">
          <div class="telemetry-item"><div>Posisi</div><div class="telemetry-value" id="position">-</div></div>
          <div class="telemetry-item"><div>SOG</div><div class="telemetry-value" id="sog">- knot</div></div>
          <div class="telemetry-item"><div>COG</div><div class="telemetry-value" id="cog">-Â°</div></div>
          <div class="telemetry-item"><div>Baterai</div><div class="telemetry-value" id="battery">- %</div></div>
        </div>
        <div class="mission-phase" id="mission-phase">Menunggu data...</div>
      </div>

      <div class="panel">
        <h2>ðŸŽ¯ Mission Control</h2>
        <div id="mission-progress">
          <div>ðŸŸ¢ Preparation</div>
          <div>âšª Reading Ball Set 1-10</div>
          <div>âšª Surface Imaging</div>
          <div>âšª Underwater Imaging</div>
          <div>âšª Finish</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>ðŸ“· Surface Camera Feed</h2>
      <div class="camera-feed">
        <div class="camera-box">
          <div class="camera-image" id="surface-image">No image</div>
          <div>Status: <span id="surface-status">Waiting...</span></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>ðŸ”§ Development Tools</h2>
      <button onclick="simulateData()">ðŸŽ® Simulate ASV Data</button>
      <button onclick="startWebcam()">ðŸ“· Start Webcam Test</button>
      <button onclick="resetData()">ðŸ”„ Reset</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentTeamId = 'DEV_TEAM_001';
    let simulationInterval = null;
    let lastImageUpdate = 0;

    socket.on('connect', () => {
      document.getElementById('connection-status').textContent = 'ðŸŸ¢ Connected';
      document.getElementById('connection-status').className = 'status-connected';
    });

    socket.on('disconnect', () => {
      document.getElementById('connection-status').textContent = 'ðŸ”´ Disconnected';
      document.getElementById('connection-status').className = 'status-disconnected';
    });

    socket.on('real-time-update', updateTelemetry);
    socket.on(`team-${currentTeamId}-image`, displayImage);

    function updateTelemetry(data) {
      if (data.position)
        document.getElementById('position').textContent = `${data.position.lat.toFixed(6)}, ${data.position.lng.toFixed(6)}`;
      if (data.sog)
        document.getElementById('sog').textContent = `${data.sog} knot (${(data.sog * 1.852).toFixed(2)} km/h)`;
      if (data.cog)
        document.getElementById('cog').textContent = `${data.cog}Â°`;
      if (data.battery)
        document.getElementById('battery').textContent = `${data.battery}%`;
      if (data.missionPhase)
        document.getElementById('mission-phase').textContent = `ðŸŽ¯ Mission Phase: ${data.missionPhase}`;
    }

    function displayImage(imageData) {
      const now = performance.now();
      if (now - lastImageUpdate < 150) return; // batasi update ke 6-7fps
      lastImageUpdate = now;

      requestAnimationFrame(() => {
        const imageUrl = `data:image/jpeg;base64,${imageData.imageData}`;
        const container = document.getElementById(`${imageData.cameraType}-image`);
        let imgElement = document.getElementById(`${imageData.cameraType}-img`);

        if (!imgElement) {
          imgElement = document.createElement('img');
          imgElement.id = `${imageData.cameraType}-img`;
          imgElement.style.maxWidth = '100%';
          imgElement.style.maxHeight = '100%';
          imgElement.style.objectFit = 'cover';
          imgElement.style.borderRadius = '10px';
          container.innerHTML = '';
          container.appendChild(imgElement);
        }
        imgElement.src = imageUrl;
        document.getElementById(`${imageData.cameraType}-status`).textContent =
          `âœ… ${new Date().toLocaleTimeString()}`;
      });
    }

    function simulateData() {
      clearInterval(simulationInterval);
      simulationInterval = setInterval(() => {
        const simulatedData = {
          teamId: currentTeamId,
          timestamp: new Date().toISOString(),
          position: { lat: -6.2 + (Math.random() - 0.5) * 0.01, lng: 106.8 + (Math.random() - 0.5) * 0.01 },
          sog: 2 + Math.random() * 3,
          cog: Math.random() * 360,
          battery: 80 + Math.random() * 20,
          missionPhase: ['Preparation','Navigation','Surface Imaging','Underwater Imaging','Finish'][Math.floor(Math.random() * 5)]
        };
        socket.emit('telemetry-data', simulatedData);
      }, 2000);
      console.log('Simulation started.');
    }

    function startWebcam() {
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        window.captureInterval = setInterval(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const base64Data = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]; // lebih ringan 50%
          socket.emit('image-stream', {
            teamId: currentTeamId,
            cameraType: 'surface',
            imageData: base64Data,
            timestamp: new Date().toISOString(),
            missionPhase: 'Surface Imaging Test'
          });
        }, 250); // sekitar 4fps cukup untuk monitoring
      }).catch(err => console.error('Error accessing webcam:', err));
    }

    function resetData() {
      clearInterval(simulationInterval);
      clearInterval(window.captureInterval);
      document.getElementById('position').textContent = '-';
      document.getElementById('sog').textContent = '- knot';
      document.getElementById('cog').textContent = '-Â°';
      document.getElementById('battery').textContent = '- %';
      document.getElementById('mission-phase').textContent = 'Menunggu data...';
      document.getElementById('surface-image').innerHTML = 'No image';
      document.getElementById('surface-status').textContent = 'Waiting...';
    }
  </script>
</body>
</html>
